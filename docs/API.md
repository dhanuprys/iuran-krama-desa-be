# REST API Documentation (v1)

## Overview
API for managing Banjar (traditional neighborhoods), Resident Statuses, Residents, Invoices, Announcements, and Audit Logs. 

- **Base URL**: `/api/v1`
- **Auth**: `Bearer <token>` (from login endpoint)
- **Content-Type**: `application/json`
- **Date format**: `YYYY-MM-DD`
- **Money format**: decimal with 2 digits
- **Locale**: `id` (Indonesian) - Validation messages are in Bahasa Indonesia.

## Roles & Capabilities

The system defines two primary roles, each with distinct access levels.

### 1. Admin
Administrators have full control over the system.
- **Manage Residents**: Create, approve, update, and delete resident data.
- **Manage Invoices**: Generate monthly invoices for residents.
- **Manage Announcements**: Publish system-wide announcements.
- **System Oversight**: View audit logs and track system activity.

### 2. Krama (Member)
Regular users who are members of the Banjar.
- **Self Service**: Register and manage their own profile.
- **Resident Application**: Apply to become a validated resident (requires `can_create_resident` permission).
- **View Data**: View their own resident data and billing history (invoices).
- **Information**: View active system announcements.

## Core Application Flows

### 1. Resident Onboarding
1. **Registration**: User registers a new account via `/api/v1/register`. Role defaults to `krama`.
2. **Application**: User submits a resident application via `POST /api/v1/krama/residents`. The validation status is locally set to `PENDING`.
3. **Validation**: Admin reviews the application.
   - If valid, Admin updates the resident via `PUT /api/v1/admin/residents/{id}` setting validation status to `APPROVED`.

### 2. Billing Cycle
1. **Invoice Generation**: Admin creates an invoice for a resident via `POST /api/v1/admin/invoices`.
   - The system validates that no invoice exists for that specific month.
   - The system automatically calculates `iuran_amount` based on the resident's assigned status configuration.
2. **Distribution**: The Krama user can immediately view this invoice in their list via `GET /api/v1/krama/invoices`.

## Standardized Response Structure
All endpoints return a consistent JSON structure generated by `ResponseHelper`.

### Success Response
```json
{
  "success": true,
  "error": null,
  "data": { ... }, // Object or Array
  "meta": {
    "trace_id": "uuid-string",
    "timestamp": 1234567890
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "ERR-BIZ-002",
    "message": "Human readable error message",
    "details": { "field": ["Validation error message"] } // Optional
  },
  "meta": {
    "trace_id": "uuid-string",
    "timestamp": 1234567890
  }
}
```

### Paginated Response
```json
{
  "success": true,
  "error": null,
  "data": [ ... ],
  "pagination": {
    "current_page": 1,
    "last_page": 5,
    "per_page": 15,
    "total": 75
  },
  "meta": { ... }
}
```

---

## Authentication
Public endpoints for registration and login.

### Register
**POST** `/api/v1/register`
- **Body**: `name`, `email`, `password`, `password_confirmation`, `role` (default: 'krama')

### Login
**POST** `/api/v1/login`
- **Body**: `email`, `password`
- **Response**: Returns `token` and `token_type` ("Bearer").

### Logout
**POST** `/api/v1/logout` (Auth required)

### Profile
- **GET** `/api/v1/profile` (Auth required)
  - **Response**: Returns the authenticated user's details.
- **PUT** `/api/v1/profile` (Auth required)
  - **Body**: `name`, `username`, `email`, `password`, `password_confirmation`.
  - **Response**: Updates and returns user details.

---

## Krama API
Endpoints for Krama (regular users). Prefix: `/api/v1/krama`.

### Residents (Krama)
- **GET** `/residents`: List residents linked to the current user. Returns `validation_status`.
- **POST** `/residents`: Apply for a new resident record (Validation Status: PENDING).
  - **Prerequisite**: User must have `can_create_resident` permission (granted by Admin).
  - **Body** (`multipart/form-data`): 
    - `nik`, `family_card_number`, `name`, `gender`, `place_of_birth`, `date_of_birth`, `family_status`, `banjar_id`, `phone`, `address`.
    - `photo_house`, `resident_photo`, `photo_ktp` (Images, max 5MB).
- **PUT** `/residents/{id}`: Update specific resident details.
  - **Condition**: Only allowed if `validation_status` is `PENDING`.
  - **Body**: Supports `multipart/form-data` for file updates.
- **GET** `/residents/{id}`: View specific resident details (must belong to user).

### Invoices (Krama)
- **GET** `/invoices`: List invoices linked to a specific resident.
  - **Query Param**: `resident_id` (Required). Must belong to the authenticated user.
- **GET** `/invoices/{id}`: View specific invoice (must belong to user).

### Announcements (Krama)
- **GET** `/announcements`: List active announcements.

---

## Admin API
Endpoints for Administrators. Prefix: `/api/v1/admin`. Requires `admin` role.

### Families (Admin)
Manage family groups (aggregated by `family_card_number`).
- **GET** `/families`: List unique families.
  - Returns `family_card_number` and potentially the `head_of_family` object.
- **GET** `/families/{family_card_number}`: List all members of a specific family.
  - Returns `family_card_number` and a `members` array of residents.

### Users (Admin)
Manage system users (Admin and Krama).
- **GET** `/users`: List all users with pagination and filtering.
- **POST** `/users`: Create a new user.
  - **Body**: `name`, `username`, `email`, `password`, `role` (admin/krama), `can_create_resident` (boolean).
- **GET** `/users/{id}`: View user details.
- **PUT** `/users/{id}`: Update user details.
  - **Body**: Same as POST (optional fields). `can_create_resident` can be toggled here.
- **DELETE** `/users/{id}`: Delete user (cannot delete self).

### Residents (Admin)
Full CRUD for resident management.
- **GET** `/residents`: List all residents with pagination and filtering.
- **POST** `/residents`: Create a new resident (Validation Status: APPROVED).
- **GET** `/residents/{id}`: View resident.
- **PUT** `/residents/{id}`: Update resident.
- **DELETE** `/residents/{id}`: Delete resident.

### Invoices (Admin)
Full CRUD for invoice management.
- **GET** `/invoices`: List all invoices.
- **POST** `/invoices`: Create invoice.
  - **Rules**: One invoice per resident per month. `iuran_amount` is auto-calculated.
- **GET** `/invoices/{id}`: View invoice.
- **PUT** `/invoices/{id}`: Update invoice.
- **DELETE** `/invoices/{id}`: Delete invoice.

### Announcements (Admin)
Manage system announcements.
- **GET** `/announcements`: List all announcements.
- **POST** `/announcements`: Create announcement (`title`, `content`, `is_active`).
- **GET** `/announcements/{id}`: View announcement.
- **PUT** `/announcements/{id}`: Update announcement.
- **DELETE** `/announcements/{id}`: Delete announcement.

### Audit Logs (Admin)
Read-only access to system activity logs.
- **GET** `/audit-logs`: List audit logs.
- **GET** `/audit-logs/{id}`: View audit log details.

### Dashboard (Admin)
System statistics.
- **GET** `/dashboard`: Returns counts of residents, families, invoices, and revenue.

---

## Common Error Codes
Defined in `config/api_errors.php`.

| Code | HTTP | Description |
|---|---|---|
| `ERR-AUTH-001` | 401 | Invalid login details |
| `ERR-VAL-001` | 422 | Validation Error |
| `ERR-BIZ-002` | 409 | Duplicate invoice in same month |
| `ERR-RES-001` | 404 | Resource not found |
| `ERR-DB-001` | 409 | Foreign key constraint violation |
